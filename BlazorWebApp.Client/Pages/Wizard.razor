@page "/wizard"
@rendermode InteractiveAuto
@using BlazorWebApp.Shared
@using MudBlazor
@using BlazorWebApp.Client.Pages
@using BlazorWebApp.Client.Services
@inject IWizardFormService WizardService
@inject WizardStateService StateService

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudCard Elevation="3" Class="rounded-lg">
        <MudCardHeader>
            <MudText Typo="Typo.h5">Multi-Step Form</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudStepper @bind-Value="StateService.CurrentStep" Linear="true" Color="Color.Primary">
                <MudStep Title="Personal Info" Icon="@Icons.Material.Filled.Person">
                    <MudText Typo="Typo.h6" Class="mb-4">First Name</MudText>
                    <BlazorWebApp.Client.Pages.WizardStep1 FormData="StateService.FormData" />
                    <div class="d-flex justify-end mt-4">
                        <MudButton T="string" Variant="Variant.Filled" Color="Color.Primary" OnClick="@NextStep">Next</MudButton>
                    </div>
                </MudStep>
                <MudStep Title="Additional Info" Icon="@Icons.Material.Filled.Info">
                    <MudText Typo="Typo.h6" Class="mb-4">Last Name</MudText>
                    <BlazorWebApp.Client.Pages.WizardStep2 FormData="StateService.FormData" />
                    <div class="d-flex justify-space-between mt-4">
                        <MudButton T="string" Variant="Variant.Outlined" OnClick="@PrevStep">Back</MudButton>
                        <MudButton T="string" Variant="Variant.Filled" Color="Color.Primary" OnClick="@NextStep">Next</MudButton>
                    </div>
                </MudStep>
                <MudStep Title="Review & Submit" Icon="@Icons.Material.Filled.CheckCircle">
                    <MudText Typo="Typo.h6" Class="mb-4">Review Your Information</MudText>
                    <BlazorWebApp.Client.Pages.WizardReview FormData="StateService.FormData" />
                    <div class="d-flex justify-space-between mt-4">
                        <MudButton T="string" Variant="Variant.Outlined" OnClick="@PrevStep">Back</MudButton>
                        <MudButton T="string" Variant="Variant.Filled" Color="Color.Success" OnClick="@OnSubmit">Submit</MudButton>
                    </div>
                    @if (_submitted)
                    {
                        <MudAlert Severity="Severity.Success" Class="mt-4">Form submitted successfully!</MudAlert>
                    }
                </MudStep>
            </MudStepper>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private bool _submitted = false;

    protected override async Task OnInitializedAsync()
    {
        await StateService.InitializeAsync();
    }

    private async Task NextStep()
    {
        if (StateService.CurrentStep < 2)
        {
            await StateService.NextStepAsync();
        }
    }

    private async Task PrevStep()
    {
        if (StateService.CurrentStep > 0)
        {
            await StateService.PreviousStepAsync();
        }
    }

    private async Task OnSubmit()
    {
        await WizardService.SubmitFormAsync(StateService.FormData);
        _submitted = true;

        // Clear the state after successful submission
        await StateService.ClearStateAsync();
    }
}
